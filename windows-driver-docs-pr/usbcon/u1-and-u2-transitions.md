---
Description: 本主题首先介绍软件实现 U1 和 U2 转换所执行的初始设置，然后介绍这些转换在硬件中的发生方式。
title: U1 和 U2 转换
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 3e8cc5f049fcc6da78c0fb140f81e7bcece05522
ms.sourcegitcommit: b316c97bafade8b76d5d3c30d48496915709a9df
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/13/2020
ms.locfileid: "79242750"
---
# <a name="u1-and-u2-transitions"></a>U1 和 U2 转换


本主题首先介绍软件实现 U1 和 U2 转换所执行的初始设置，然后介绍这些转换在硬件中的发生方式。

## <a name="initial-setup-by-software"></a>由软件初始设置


本主题介绍软件如何枚举设备。

对于 U1 或 U2 转换，软件在枚举设备的过程中执行以下步骤。

1.  在枚举过程中，软件与设备交换 U1 或 U2 出口延迟信息。 作为此交换的第一部分，设备特定的延迟由设备在 SuperSpeed USB 设备功能的 bU1DevExitLat 和 wU2DevExitLat 字段中填充（在 USB 3.0 规范的第9.6.2.2 节中定义）。 作为交换的第二部分，主机会通过发送\_SEL 控制传输集来向设备通知设备的总体出口延迟，这一点与 USB 3.0 规范的每节9.4.12 一样。 延迟信息包括与上游链接和控制器关联的延迟。
2.  对于设备附加到的 DS 端口，软件将配置两个值：端口\_U1\_超时和端口\_U2\_超时。 在确定这些值的同时，软件将考虑设备的特征（如终结点类型）以及与将设备从 U1 或 U2 恢复到 U0 相关联的延迟。 下表描述了超时值。

    **表1。端口\_U1\_超时和端口\_U2\_超时值**

    | 值   | 说明                                                                                                                                                                                                                  |
    |---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | 01H-FEH | DS 端口必须在一段非活动期后启动转换。 确切的时间段是从超时值派生的。 端口必须接受链接伙伴启动的转换，除非存在挂起的流量。 |
    | FFH     | DS 端口不得启动转换，但必须接受链接伙伴启动的转换，除非存在挂起的流量。                                                                                    |
    | 0       | DS 端口不得启动转换，并且不能接受链接伙伴启动的转换。                                                                                                                |

     

3.  如果端口\_U2\_超时值介于 01H-FEH 之间，则由于步骤2的原因，硬件中会出现一个额外的步骤。 DS 端口通知其链接伙伴该值。 在 "从 U1 到 U2 的直接转换" 中介绍了此步骤的重要性。
4.  对于每个设备或集线器，软件将配置两个值： U1\_ENABLE and U2\_ENABLE （\_U1\_ENABLE/U2\_ENABLE） control 传输。 下表描述了这些值。

    **表2：U1\_ENABLE 和 U2\_启用值**

    | 值    | 说明                                                                                                                       |
    |----------|-----------------------------------------------------------------------------------------------------------------------------------|
    | 已启用  | 如果设备策略允许，US 端口可以启动转换并接受链接伙伴启动的转换。 |
    | 已禁用 | US 端口不得启动转换，但可以接受由链接伙伴启动的转换。                          |

     
## <a name="hardware-transitions"></a>硬件转换


本主题介绍了到 U1 和 U2 的硬件转换。

完成软件的初始设置后，硬件会自行过渡到 U1 和 u2，无需进一步干预软件。

只要正在主动传输数据包，链接就处于工作状态（U0）。 当没有传输任何数据包时，此链接被视为空闲。 在空闲状态下，任何链接伙伴都可以启动到 U1 或 U2 的转换。 其他链接伙伴可以选择接受或拒绝转换。 如果链接伙伴接受转换，链接将转到该 U 状态。 如果拒绝转换，该链接将保留在 U0 中。

### <a name="ds-port-initiated-transitions"></a>DS 端口启动的转换


DS 端口实现一种计时器机制，该机制跟踪端口上的非活动状态。 只要该端口发送或接收数据包，就会重置计时器。 当软件计划新的超时值时，还会重置计时器。 如果软件已将 DS 端口编程为仅启动 U1 或 U2 转换，则在链接首次进入 U0 时，DS 端口会启动计时器。 计时器值基于软件所编程的 U1 （或 U2）超时值。 如果在计时器过期时链接在 U0 中，则 DS 端口会启动 U1 （或 U2）转换。

如果设备知道转换可能会影响设备满足性能或延迟要求的能力，则可以选择拒绝过渡。 例如，如果设备已发送 ERDY 通知，并且需要主机发送传输请求，则设备可能会在此期间拒绝 U1 或 U2 状态转换。

如果软件已将 DS 端口设计为同时启动 U1 和 U2 转换，则 DS 端口首先会根据计时器启动 U1 转换（本部分前面所述）。 从 u1 到 u2 的**直接转换**中介绍了本主题中从 U1 到 u2 的转换。

如果某个链接处于 U1 或 U2，则在每次收到连接到该端口的设备的流量时，DS 端口都可以使该端口返回到 U0。

### <a name="device-us-port-initiated-transitions"></a>设备（US 端口）-已启动的转换


只要软件启用了此功能，设备就可以选择启动从 U0 到 U1 或 U0 到 U2 的转换。 如果设备转换为 U1 的链接，则该链接可以根据 DS 端口的 U2 计时器直接过渡到 U2 （如 "从 U1 到 U2 的直接转换" 中所述）。 但是，如果未设置 U2 计时器，则设备无法启动从 U1 到 U2 的直接转换。 在这种情况下，在开始过渡到 U2 之前，设备必须将链接返回到 U0。

在确定启动这些转换的时间时，设备应考虑其出口延迟和性能要求。 为了帮助设备作出有关其启动转换的主动的决定，软件还提供各种退出延迟值，如本文档前面的 "按软件进行的初始设置" 中所述。

如果此链接位于 U1 或 U2，则可以随时将此端口导入 U0。 通常，当美国端口知道要将任何数据包发送到主机或从主机中预测数据包时，会开始转换为 U0。

### <a name="advantages-of-device-initiated-lpm"></a>设备启动的 LPM 的优点


用于 DS 端口的软件设置的计时器值基于常规试探法。 选择这些计时器值时，软件可确保设备性能不会受到影响。 为了维持设备性能，软件无法选择太小的值。 由于 DS 端口启动的转换基于计时器，并且不考虑设备的确切状态，因此这种机制无法充分利用将设备发送到 U1 或 U2 状态的所有可能机会。

另一方面，该设备具有有关其特征和当前状态的准确知识。 因此，它可以使智能推测到下一次传输发生的时间。 根据该信息，设备可以（并且应该）选择主动启动这些转换，而不会显著影响性能。

例如，设备已将 NRDY 通知发送到其中一个终结点，并且知道有一段时间没有流量。 在这种情况下，设备可以立即启动到 U1 或 U2 的转换。 在发送 ERDY 通知之前，设备可以将该链接返回到 U0，以便准备发送该数据。 有关此过程的详细信息，请参阅 USB 3.0 规范的第 C 节。

## <a name="direct-transition-from-u1-to-u2"></a>从 U1 到 U2 的直接转换


如果此链接位于 U1 中，则该链接可以直接转换到 U2，而无需在之间输入 U0。 不管哪个链接伙伴启动了到 U1 的转换，都可能出现这种情况。 但是，仅当链接 DS 端口上的 U2 超时设置为 01H-FEH 之间的值时，才会发生 U1 到 U2 转换。

"由软件初始设置" 部分介绍了一种附加步骤，该步骤允许 DS 端口将超时值传达给其链接伙伴。 在链接进入 U1 后，这两个链接伙伴都将使用根据 DS 端口的 U2 timeout 值设置的超时值启动计时器。 如果计时器由于流量而不重置，则链接伙伴会以静默方式转换到 U2，而不会在它们之间进行任何显式通信。

### <a name="transitions-from-u1-or-u2-to-u3"></a>从 U1 或 U2 过渡到 U3


到 U1 或 U2 的过渡在硬件中自动启动，但转换到 U3 是由软件启动的。 由于仅在一段非活动期后启动 U3 转换，因此，在转换之前，该链接很可能位于 U1 或 U2 （而不是 U0）中。

USB 3.0 规范未定义从 U1 或 U2 到 U3 的直接转换。 父集线器或控制器负责自动将链接转换为 U0，然后将其转换为 U3。

### <a name="u1-or-u2-transitions-for-hubs"></a>用于中心的 U1 或 U2 转换


USB 3.0 规范为中心提供有关何时在其美国端口上启动 U 状态转换的特定指导原则。 如果所有 DS 端口都处于链接状态 U1 或更低，则中心应在其美国端口上启动 U1 转换，假定软件启用了中心来启动 U1 转换。

同样，如果所有 DS 端口都处于连接状态 U2 或更低，则集线器应在其美国端口上启动 U2 转换，假设软件启用了中心来启动 U2 转换。

**请注意**   如果没有设备连接到 DS 端口，则端口的状态为 "Rx"。 "检测" 低于 U2。 如果没有附加设备，集线器应将其 US 端口发送到 U2。 而且，如果所有 DS 端口最初都是 U1 或更低，并且它们转换为 U2 或更低，则中心应将美国端口从 U1 转换到 U2。 由于该转换不基于 U2 活动计时器，因此中心必须将其 US 端口 U0，然后将其发送到 U2。

 

## <a name="packet-deferring"></a>数据包延迟


USB 3.0 规范介绍了一种称为数据包延迟的机制（请参阅1.2.2）。 该机制用于最大程度地降低 LPM 对总线利用率的影响。

如果主机将传输请求发送到设备，而该设备的上游链接位于 U1 或 U2，则主机可能会通过等待链接返回到 U0，然后让设备做出响应，从而最终浪费总线带宽。 为避免等待，父集线器会通过将延迟的数据包标头发送回主机来代表设备做出响应。 主机以类似于 NRDY 的方式处理延迟的数据包标头，然后可以自由地启动与其他终结点的传输。 在并行情况下，中心会在链接上启动 U0 转换，并通知设备有关延迟的数据包的信息。 设备然后将 ERDY 发送到主机，以指示该设备现在已准备好进行传输。 然后，主机可以重新安排到设备的传输。

设备的一项重要责任是，在发送 ERDY 后，该设备负责将链接保存在 U0 中，直到主机将响应发送到 ERDY 或到达**tERDYTimeout** （500毫秒）的时间。 在此期间，设备不得启动 U1 或 U2 转换，并且还应拒绝由其链接伙伴启动的任何转换。

 

 
 

 

 




